

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dart VM Advent Calendar 2012 12/07 &mdash; Dart VM Overview 1.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="Dart VM Overview 1.0 documentation" href="../index.html" />
    <link rel="up" title="Dart VM index" href="advent201212index.html" />
    <link rel="prev" title="Dart VM Advent Calendar 2012 12/05" href="advent20121205.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Dart VM Overview 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Dart VM Advent Calendar 2012 12/07</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="advent20121205.html">Dart VM Advent Calendar 2012 12/05</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="dart-vm-advent-calendar-2012-12-07">
<h1>Dart VM Advent Calendar 2012 12/07<a class="headerlink" href="#dart-vm-advent-calendar-2012-12-07" title="Permalink to this headline">¶</a></h1>
<p>VM Advent Calendar 2012/12/07</p>
<div class="section" id="dart-vm-3">
<h2>Dart VMの概要(3)<a class="headerlink" href="#dart-vm-3" title="Permalink to this headline">¶</a></h2>
<p>前回の続き、fiboが2000回以上よばれて最適化JITコンパイルされるところから！！！</p>
</div>
<div class="section" id="fibo">
<h2>fiboの中間表現(非最適化時)<a class="headerlink" href="#fibo" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>
==== file:///home/elise/language/dart/work/adven/fibo.dart_::_fibo
B0[graph]
B1[target]
    CheckStackOverflow:2()
    t0 &lt;- LoadLocal:3(n lvl:0)                        //変数nをLoad(引数という概念はここではない)
    t1 &lt;- Constant:4(#2)                              //定数2を生成
    Branch if RelationalOp:5(&lt;, t0, t1) goto (2, 3)   //(t0 &lt; t1)だったら、B2へjump、もしくはB3へjump
B2[target]
    t0 &lt;- LoadLocal:7(n lvl:0)                        //定数nをLoad
    Return:8(t0)                                      //Return
B3[target]
    t0 &lt;- LoadLocal:9(n lvl:0)                        //変数nをLoad
    PushArgument:10(t0)                               //nを引数にpush
    t0 &lt;- Constant:11(#1)                             //定数1を生成
    PushArgument:12(t0)                               //#1を引数にpush
    t0 &lt;- InstanceCall:13(-, t0, t0)                  //InstanceCall (-)(n, #1)みたいなメソッドコール
    PushArgument:14(t0)                               //返値をpush        [`n-1`]
    t0 &lt;- StaticCall:15(fibo t0)                      //fibo(n-1)に相当
    PushArgument:16(t0)                               //返値をpush        [`fibo(n-1)`]
    t0 &lt;- LoadLocal:17(n lvl:0)                       //変数nをLoad
    PushArgument:18(t0)                               //nをpush
    t0 &lt;- Constant:19(#2)                             //定数2を生成
    PushArgument:20(t0)                               //#2をpush
    t0 &lt;- InstanceCall:21(-, t0, t0)                  //InstanceCall (-)(n, 2)みたいなメソッドコール
    PushArgument:22(t0)                               //返値をpush        [`fibo(n-1)`, `n-2`]
    t0 &lt;- StaticCall:23(fibo t0)                      //fibo(n-2)に相当
    PushArgument:24(t0)                               //返値をpush        [`fibo(n-1)`, `fibo(n-2)`]
    t0 &lt;- InstanceCall:25(+, t0, t0)                  //InstanceCall (+)(`fibo(n-1)`, `fibo(n-2)`)
    Return:26(t0)                                     //返値をreturn

</pre>
</div>
</div>
<div class="section" id="id1">
<h2>fiboの中間表現(最適化時、型情報のフィードバック後)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>==== file:///home/elise/language/dart/work/adven/fibo.dart_::_fibo
B0[graph] {
      v0 &lt;- Constant:29(#null)
      v1 &lt;- Parameter:30(0)
}
B1[target]
    CheckStackOverflow:2()
    v2 &lt;- Constant:4(#2)
    Branch if RelationalOp:5(&lt;, v1, v2 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #588]) goto (2, 3) env={ v1, v1, v2 }
B2[target]                                   ^ (&lt;)のreceiverがSmi  ^ arg1がSmi
    Return:8(v1)
B3[target]
    PushArgument:10(v1)
    v3 &lt;- Constant:11(#1)
    PushArgument:12(v3)
    v4 &lt;- InstanceCall:13(-, v1, v3 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #309]) env={ v1, a0, a1 }
    PushArgument:14(v4)                   ^ (-)のreceiverがSmi  ^ arg1がSmi
    v5 &lt;- StaticCall:15(fibo v4) env={ v1, a0 }
    PushArgument:16(v5)
    PushArgument:18(v1)
    v6 &lt;- Constant:19(#2)
    PushArgument:20(v6)
    v7 &lt;- InstanceCall:21(-, v1, v6 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #278]) env={ v1, a0, a1, a2 }
    PushArgument:22(v7)                   ^ (-)のreceiverがSmi ^ arg1がSmi
    v8 &lt;- StaticCall:23(fibo v7) env={ v1, a0, a1 }
    PushArgument:24(v8)
    v9 &lt;- InstanceCall:25(+, v5, v8 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #274]) env={ v1, a0, a1 }
    Return:26(v9)                         ^ (+)のreceiverがSmi ^ arg1がSmi
</pre>
</div>
<p>非最適化のfiboのコードを実行した際に、値がSmi型であると記録しておき、
最適化JITコンパイル時には、その型情報をフィードバックします。</p>
<p>型情報は、receiverとargのペアで記録されます。</p>
<p>仮に、複数の型が混在する場合、</p>
<p>[PT: _Smi, _Smi | _Smi, _Double | _Double, _Smi]のような表現になるはずです。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>一言断っておくと、JITコンパイル(非最適化)の中間表現は非SSA形式です。</p>
<p class="last">JITコンパイル(最適化)の中間表現はSSA形式になるため、
IRのdefinevalueはtからvに変わって、重ならないようにnumberingされます。</p>
</div>
</div>
<div class="section" id="id2">
<h2>fiboの中間表現(最適化後)<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>==== file:///home/elise/language/dart/work/adven/fibo.dart_::_fibo
  0: B0[graph] {
      v0 &lt;- Constant:29(#null)
      v1 &lt;- Parameter:30(0) {PT: dynamic} {PCid: dynamic}
}
  2: B1[target] ParallelMove eax &lt;- S-1
  4:     CheckStackOverflow:2()
  6:     v2 &lt;- Constant:4(#2) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [2, 2]
  8:     CheckSmi:5(v1) env={ v1 [eax], v1 [eax], v2 [C] }
 10:     Branch if RelationalOp:5(&lt;, v1, v2 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #588]) goto (2, 3)
 12: B2[target]
 13:     ParallelMove eax &lt;- eax
 14:     Return:8(v1)
 16: B3[target]
 18:     v3 &lt;- Constant:11(#1) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [1, 1]
 20:     ParallelMove ecx &lt;- eax
         //v4 &lt;- InstanceCall:13(-, v1, v3 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #309]) env={ v1, a0, a1 }
 20:     v4 &lt;- BinarySmiOp:13(-, v1, v3) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [1, 1073741822] -o        &lt;-- Smi型に特殊化された中間表現
 22:     PushArgument:14(v4) {PCid: dynamic}
         //v5 &lt;- StaticCall:15(fibo v4) env={ v1, a0 }
 24:     v5 &lt;- StaticCall:15(fibo v4) {PT: dynamic} {PCid: dynamic} env={ v1 [S-1], a0 }
 25:     ParallelMove eax &lt;- eax
 26:     ParallelMove ecx &lt;- S-1, S+0 &lt;- eax
         //v7 &lt;- InstanceCall:21(-, v1, v6 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #278]) env={ v1, a0, a1, a2 }
 26:     v7 &lt;- BinarySmiOp:21(-, v1, v2) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [0, 1073741821] -o        &lt;-- Smi型に特殊化された中間表現
 28:     PushArgument:22(v7) {PCid: dynamic}
         //v8 &lt;- StaticCall:23(fibo v7) env={ v1, a0, a1 }
 30:     v8 &lt;- StaticCall:23(fibo v7) {PT: dynamic} {PCid: dynamic} env={ v1 [S-1], v5 [S+0], a0 }
 31:     ParallelMove ecx &lt;- eax, eax &lt;- S+0
 32:     CheckSmi:25(v5) env={ v1 [S-1], v5 [eax], v8 [ecx] }
 34:     CheckSmi:25(v8) env={ v1 [S-1], v5 [eax], v8 [ecx] }
 36:     ParallelMove edx &lt;- eax
         //v9 &lt;- InstanceCall:25(+, v5, v8 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #274]) env={ v1, a0, a1 }
 36:     v9 &lt;- BinarySmiOp:25(+, v5, v8) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [-inf, +inf] +o env={ v1 [S-1], v5 [eax], v8 [ecx] } &lt;-- Smi型に特殊化された中間表現
 37:     ParallelMove eax &lt;- edx
 38:     Return:26(v9)
</pre>
</div>
<p>最適化後の中間表現です。最適化により様々な変化があります。</p>
<ol class="arabic simple">
<li>型情報のフィードバック結果から型推論を行う。</li>
<li>CheckSmi命令の挿入</li>
<li>型推論の結果、高速な中間表現に置き換える。</li>
<li>スタックとレジスタ割付けが行われ、ParallelMove命令に置き換える。</li>
</ol>
<p>高速な命令に置き換える、では、Smi型でのみ呼び出すInstance命令をBinarySmiOpに置き換えています。</p>
<p>BinarySmiOpは、receiverとarg1がSmi型である場合に置き換えられる(特殊化)命令になります。</p>
<p>BinarySmiOpは、最終的にアセンブラ数命令に変換されます。</p>
<p>Check命令の挿入は、少々特殊なことを行います。</p>
<div class="highlight-python"><pre>24:     v5 &lt;- StaticCall:15(fibo v4)
30:     v8 &lt;- StaticCall:23(fibo v7)
32:     CheckSmi:25(v5) env={ v1 [S-1], v5 [eax], v8 [ecx] }  &lt;-- CheckSmi
34:     CheckSmi:25(v8) env={ v1 [S-1], v5 [eax], v8 [ecx] }  &lt;-- CheckSmi
36:     ParallelMove edx &lt;- eax
36:     v9 &lt;- BinarySmiOp:25(+, v5, v8) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72}</pre>
</div>
<p>上記は、v5とv8をCheckSmi命令で、Smi型であることを保証した上で(Smi型のGuard)
BinarySmiOp(+, v5, v8)を行っています。</p>
<p>v5とv8は、StaiticCall(fibo)の返値であり、Smi型である保証がないため、CheckSmiで確認を行っています。</p>
<p>BinarySmiOpはSmi型でしか動作しない命令であるため、
Smi型以外が入ってきたら異常終了してしまう可能性があります。</p>
<p>仮に、StaticCall(fibo)の返値がdouble型やnull型だった場合、CheckSmiにひっかかってしまいます。</p>
<p>Smi型以外だった場合、CheckSmiは脱最適化(Deoptimization)を行い、この最適化したコードを捨て、
元のどんな型でも動く非最適化コードに戻します。</p>
<p>型情報のフィードバックを受けたこの最適化JITコンパイルが生成したコードは、
Smi型が入ってくる限り非常に高速に動作します。</p>
</div>
<div class="section" id="id3">
<h2>fiboのアセンブラ(最適化)<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>Code for optimized function 'file:///home/elise/language/dart/work/adven/fibo.dart_::_fibo' {
0xb3048308    55                     push ebp              //  v0 &lt;- Constant:29(#null)
0xb3048309    89e5                   mov ebp,esp           //  v1 &lt;- Parameter:30(0) {PT: dynamic} {PCid: dynamic}
0xb304830b    e800000000             call 0xb3048310
0xb3048310    83ec04                 sub esp,0x4
0xb3048313    8b4508                 mov eax,[ebp+0x8]     //  2: B1[target] ParallelMove eax &lt;- S-1
0xb3048316    3b257c7a6b08           cmp esp,[0x86b7a7c]   //  4:     CheckStackOverflow:2()
0xb304831c    0f8668000000           jna 0xb304838a
                                                           //  8:     CheckSmi:5(v1) env={ v1 [eax], v1 [eax], v2 [C] }
0xb3048322    a801                   test al,0x1           // check SmiTag
0xb3048324    0f8573000000           jnz 0xb304839d        // goto DeoptimizeStub
                                                           //  6:     v2 &lt;- Constant:4(#2) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [2, 2]
                                                           // 10:     Branch if RelationalOp:5(&lt;, v1, v2 IC[1: _Smi@0x36924d72, _Smi@0x36924d72 #588]) goto (2, 3)
0xb304832a    83f804                 cmp eax,0x4           // if n &lt; 2  // (n&lt;&lt;1 &lt; 2&lt;&lt;1)
0xb304832d    0f8d05000000           jnl 0xb3048338        // goto B3[target]
0xb3048333    89ec                   mov esp,ebp           // 14:     Return:8(v1)
0xb3048335    5d                     pop ebp
0xb3048336    c3                     ret
0xb3048337    90                     nop                   // 16: B3[target]
                                                           // 18:     v3 &lt;- Constant:11(#1) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [1, 1]
                                                           // 20:     ParallelMove ecx &lt;- eax
                                                           // 20:     v4 &lt;- BinarySmiOp:13(-, v1, v3) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [1, 1073741822] -o
0xb3048338    89c1                   mov ecx,eax
0xb304833a    83e902                 sub ecx,0x2           // n - 1  (n&lt;&lt;1 - 1&lt;&lt;1)
0xb304833d    51                     push ecx              // 22:     PushArgument:14(v4) {PCid: dynamic}
0xb304833e    bab16b0fb3             mov edx,0xb30f6bb1    // 24:     v5 &lt;- StaticCall:15(fibo v4) {PT: dynamic} {PCid: dynamic} env={ v1 [S-1], a0 }
0xb3048343    e8c0803702             call 0xb53c0408  [stub: CallStaticFunction]  // call fibo(n-1)
0xb3048348    83c404                 add esp,0x4
0xb304834b    8b4d08                 mov ecx,[ebp+0x8]     // 26:     ParallelMove ecx &lt;- S-1, S+0 &lt;- eax
0xb304834e    8945f8                 mov [ebp-0x8],eax
                                                           // 26:     v7 &lt;- BinarySmiOp:21(-, v1, v2) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [0, 1073741821] -o
0xb3048351    83e904                 sub ecx,0x4           // n - 2 (n&lt;&lt;1 - 2&lt;&lt;1)
0xb3048354    51                     push ecx              // 28:     PushArgument:22(v7) {PCid: dynamic}
0xb3048355    bab16b0fb3             mov edx,0xb30f6bb1    // 30:     v8 &lt;- StaticCall:23(fibo v7) {PT: dynamic} {PCid: dynamic} env={ v1 [S-1], v5 [S+0], a0 }
0xb304835a    e8a9803702             call 0xb53c0408  [stub: CallStaticFunction]  // call fibo(n-2)
0xb304835f    83c404                 add esp,0x4
0xb3048362    89c1                   mov ecx,eax           // 31:     ParallelMove ecx &lt;- eax, eax &lt;- S+0
0xb3048364    8b45f8                 mov eax,[ebp-0x8]
                                                           // 32:     CheckSmi:25(v5) env={ v1 [S-1], v5 [eax], v8 [ecx] }
0xb3048367    a801                   test al,0x1           // check SmiTag
0xb3048369    0f8533000000           jnz 0xb30483a2        // goto DeoptimizeStub
                                                           // 34:     CheckSmi:25(v8) env={ v1 [S-1], v5 [eax], v8 [ecx] }
0xb304836f    f6c101                 test_b ecx,0x1        // check SmiTag
0xb3048372    0f852f000000           jnz 0xb30483a7        // goto DeoptimizeStub
0xb3048378    89c2                   mov edx,eax           // 36:     ParallelMove edx &lt;- eax
                                                           // 36:     v9 &lt;- BinarySmiOp:25(+, v5, v8) {PT: _Smi@0x36924d72} {PCid: _Smi@0x36924d72} [-inf, +inf] +o env={ v1 [S-1], v5 [eax], v8 [ecx] }
0xb304837a    03d1                   add edx,ecx           // fibo(n-1) + fibo(n-2)
0xb304837c    0f802a000000           jo 0xb30483ac
0xb3048382    89d0                   mov eax,edx           // 37:     ParallelMove eax &lt;- edx
0xb3048384    89ec                   mov esp,ebp           // 38:     Return:26(v9)
0xb3048386    5d                     pop ebp
0xb3048387    c3                     ret
//Runtime
0xb3048388    90                     nop
0xb3048389    cc                     int3
0xb304838a    50                     push eax
0xb304838b    b9f0c20a08             mov ecx,0x80ac2f0
0xb3048390    ba00000000             mov edx,0
0xb3048395    e88e7c3702             call 0xb53c0028  [stub: CallToRuntime]
0xb304839a    58                     pop eax
0xb304839b    eb85                   jmp 0xb3048322
0xb304839d    e8c6813702             call 0xb53c0568  [stub: Deoptimize]
0xb30483a2    e8c1813702             call 0xb53c0568  [stub: Deoptimize]
0xb30483a7    e8bc813702             call 0xb53c0568  [stub: Deoptimize]
0xb30483ac    e8b7813702             call 0xb53c0568  [stub: Deoptimize]
0xb30483b1    e972813702             jmp 0xb53c0528  [stub: FixCallersTarget]
0xb30483b6    e94d823702             jmp 0xb53c0608  [stub: DeoptimizeLazy]
}



</pre>
</div>
<p>非最適化のコードと比較して、高速なコードを生成しています。</p>
<p>特に、InlineCacheのStub呼び出しをしていたところは、すべて高速な命令に置き換えられています。</p>
<p>BinarySmiOpは、アセンブラ1-2命令になっています。</p>
<p>また、BinarySmiOpでは、両者ともSmi型であるため、1bit左シフト済みの値が入っているはずですが、</p>
<p>右シフトで元の値に戻さずに、add sub cmp命令を行っています。</p>
<p>Printする場合には、右シフトが挿入されるはずです。</p>
<p>Dart VMの初期化、JITコンパイル(非最適化)、JITコンパイル(最適化)、fibo(40)の計算まで、
大体900msecくらいなので、かなり速いと思います。</p>
<p>corei7(ia32)にて、</p>
<div class="highlight-python"><pre>dart$ time dart --time-all fibo.dart
102334155
ret = 897 ms                                 &lt;-- fibo(40)の処理時間
Script Loading :  93 micros.                 &lt;-- Dart VMがソースコードを読み込んだ合計時間
Snapshot Creation :  0 micros.               &lt;-- Snapshotの合計時間、最後に行うんだっけかな？
Isolate initialization :  11019 micros.      &lt;-- Isolateの初期化時間
Function compilation :  11742 micros.        &lt;-- Compileの合計時間 main, fibo以外のcoreも含む。
Bootstrap of core classes :  28 micros.      &lt;-- Bootstrap時の、core libのdeserialize処理時間
Total runtime for isolate :  909578 micros.  &lt;-- main以降の合計時間

real  0m0.924s                               &lt;-- VMの起動時間は、25,000 microsくらいかな？
user  0m0.920s                                   実はVMのclosingに結構かかる。
sys   0m0.000s</pre>
</div>
</div>
<div class="section" id="id4">
<h2>まとめ<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>最適化JITコンパイルは、型情報のフィードバックをもらう。</li>
<li>最適化JITコンパイルは、特殊化された中間表現に置き換える。</li>
<li>特殊化された中間表現は、少ないアセンブラ命令に落ちる。</li>
</ol>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="advent20121205.html">Dart VM Advent Calendar 2012 12/05</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>


    <div class="footer">
        &copy; Copyright 2012, nothingcosmos.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15223787-5']);
  _gaq.push(['_trackPageview']);

  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
   })();

</script>


  </body>
</html>