

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dart VM Advent Calendar 2012 12/04 &mdash; Dart VM Overview 1.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="Dart VM Overview 1.0 documentation" href="../index.html" />
    <link rel="up" title="Dart VM index" href="advent201212index.html" />
    <link rel="prev" title="Dart VM Advent Calendar 2012 12/03" href="advent20121203.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Dart VM Overview 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Dart VM Advent Calendar 2012 12/04</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="advent20121203.html">Dart VM Advent Calendar 2012 12/03</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="dart-vm-advent-calendar-2012-12-04">
<h1>Dart VM Advent Calendar 2012 12/04<a class="headerlink" href="#dart-vm-advent-calendar-2012-12-04" title="Permalink to this headline">¶</a></h1>
<p>以下のバージョンで確認しています。:</p>
<div class="highlight-python"><pre>$dart --version
 Dart VM version: 0.1.2.0_15619_elise (Sun Dec  2 11:47:05 2012)
                  ^       ^            ^
                  version revision     build time</pre>
</div>
<p>環境は、Linux ubuntu12(ia32) corei7 です。</p>
<div class="section" id="dart-vm">
<h2>Dart VMの概要<a class="headerlink" href="#dart-vm" title="Permalink to this headline">¶</a></h2>
<p>一般的なVMは、ソースコードをASTに変換した後IRに変換し、そのIRをインタプリタ実行します。</p>
<p>Dart VMはV8と同様、ソースコードからAST、IRに変換し、IRをJITコンパイルしてから実行します。</p>
<p>そのため、インタプリタ実行する機能はなく、未対応のARMでは動かないです。</p>
<p>Dart VMのJITコンパイラは1つですが、OPTIONで機能を切り替えます。</p>
<ol class="arabic simple">
<li>非最適化  どんな型でも動くコードを高速に生成する。</li>
<li>最適化    最適化した、高速に動作するコードを生成する。</li>
</ol>
<p>最初にコンパイルする際には、非最適化でJITコンパイルし、コードを生成します。</p>
<p>非最適化のJITコンパイラは、何回呼び出されたかカウントするコード、
変数が何の型か情報収集するコードを埋め込んでコンパイルします。</p>
<p>その結果を参照し、2000以上呼び出された関数は、最適化JITコンパイラ(FlowGraphCompiler)で再コンパイルします。</p>
<p>最適化JITコンパイラは、、何の型の情報かフィードバックを受けて、その型に応じた高速なコードを生成します。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>AST(Abstract Syntax Tree)</p>
<p>IR(Intermediate Representation) 中間表現とよく呼びます。</p>
<p>MozillaのIonMonkeyは、JavaScriptソース &#8211;&gt; AST &#8211;&gt; IRの後に、インタプリタ実行のはず。</p>
<p>JVMは、javacがJavaソースコード &#8211;&gt; AST -&gt; Bytecode(IR)に変換し、
JVM(Hotspot)はbytecode(IR)を入力とし、Bytecodeをインタプリタ実行します。</p>
<p>LLVMでも、lliのインタプリタモードを使用すれば、Bitcodeをインタプリタ実行できます。</p>
<p>Dart VMの最適化オプションが有効な場合のJITコンパイラを、
最適化JITコンパイラとか、FlowGraphCompilerと私は呼んでいます。</p>
<p class="last">変数が何の型か情報収集するコードは、曖昧な表現で、実装は異なります。</p>
</div>
</div>
<div class="section" id="os">
<h2>対応OS<a class="headerlink" href="#os" title="Permalink to this headline">¶</a></h2>
<p>Linux, Windows, MacOSで、buildbotで確認されています。</p>
<p>Android(x86のみ)もサポートされており、
Linux(ia32)環境からクロスビルドしてAndroidEmulatorにadbで転送すると動きます。</p>
<p>os対応は、dart/runtime/vmと、dart/runtime/platformに記述されています。</p>
<table border="1" class="docutils">
<caption>os依存の規模</caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">target arch</th>
<th class="head">line</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>linux</td>
<td>3.4k</td>
</tr>
<tr class="row-odd"><td>win</td>
<td>4.2k</td>
</tr>
<tr class="row-even"><td>macos</td>
<td>3.3k</td>
</tr>
<tr class="row-odd"><td>android</td>
<td>3.4k</td>
</tr>
</tbody>
</table>
<p>linuxを例にあげると、以下のファイルがOS依存です。</p>
<table border="1" class="docutils">
<caption>os依存のソースコード一覧(Linux) dart/runtime</caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">filename</th>
<th class="head">line</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>bin/crypto_linux.cc</td>
<td>18</td>
</tr>
<tr class="row-odd"><td>bin/dbg_connection_linux.cc</td>
<td>105</td>
</tr>
<tr class="row-even"><td>bin/dbg_connection_linux.h</td>
<td>29</td>
</tr>
<tr class="row-odd"><td>bin/directory_linux.cc</td>
<td>435</td>
</tr>
<tr class="row-even"><td>bin/eventhandler_linux.cc</td>
<td>430</td>
</tr>
<tr class="row-odd"><td>bin/eventhandler_linux.h</td>
<td>121</td>
</tr>
<tr class="row-even"><td>bin/extensions_linux.cc</td>
<td>23</td>
</tr>
<tr class="row-odd"><td>bin/fdutils_linux.cc</td>
<td>134</td>
</tr>
<tr class="row-even"><td>bin/file_linux.cc</td>
<td>244</td>
</tr>
<tr class="row-odd"><td>bin/log_linux.cc</td>
<td>18</td>
</tr>
<tr class="row-even"><td>bin/platform_linux.cc</td>
<td>80</td>
</tr>
<tr class="row-odd"><td>bin/process_linux.cc</td>
<td>566</td>
</tr>
<tr class="row-even"><td>bin/socket_linux.cc</td>
<td>253</td>
</tr>
<tr class="row-odd"><td>bin/socket_linux.h</td>
<td>12</td>
</tr>
<tr class="row-even"><td>bin/utils_linux.cc</td>
<td>44</td>
</tr>
<tr class="row-odd"><td>platform/thread_linux.cc</td>
<td>281</td>
</tr>
<tr class="row-even"><td>platform/thread_linux.h</td>
<td>74</td>
</tr>
<tr class="row-odd"><td>platform/utils_linux.h</td>
<td>22</td>
</tr>
<tr class="row-even"><td>vm/debuginfo_linux.cc</td>
<td>72</td>
</tr>
<tr class="row-odd"><td>vm/gdbjit_linux.cc</td>
<td>79</td>
</tr>
<tr class="row-even"><td>vm/gdbjit_linux.h</td>
<td>15</td>
</tr>
<tr class="row-odd"><td>vm/os_linux.cc</td>
<td>233</td>
</tr>
<tr class="row-even"><td>vm/virtual_memory_linux.cc</td>
<td>98</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cpu">
<h2>ターゲットCPUアーキテクチャ<a class="headerlink" href="#cpu" title="Permalink to this headline">¶</a></h2>
<p>x86(ia32), x64 です。</p>
<p>将来、ARMにも対応予定です。
V8はMIPSにも対応していますが、Dart VMはどうでしょうね。。買収の影響とかもあるし。</p>
<p>ターゲットアーキテクチャ向けのコードは、ソースコードに_ia32とか、x64とprefixがつきます。</p>
<p>ARM向けのソースコードも多数定義されていますが、中身はからっぽです。</p>
<p>V8のようにディレクトリ単位で分かれていませんし、規模もそれほど大きくはないです。</p>
<table border="1" class="docutils">
<caption>arch依存の規模</caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">target arch</th>
<th class="head">line</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ia32</td>
<td>14k</td>
</tr>
<tr class="row-odd"><td>x64</td>
<td>14k</td>
</tr>
<tr class="row-even"><td>arm</td>
<td>1k</td>
</tr>
</tbody>
</table>
<p>ia32を例に挙げると、以下のファイルがarch依存です。</p>
<table border="1" class="docutils">
<caption>arch依存のソースコード一覧(ia32) dart/runtime/vm</caption>
<colgroup>
<col width="67%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">filename</th>
<th class="head">line</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>assembler_ia32.cc</td>
<td>2044</td>
</tr>
<tr class="row-odd"><td>assembler_ia32.h</td>
<td>706</td>
</tr>
<tr class="row-even"><td>assembler_macros_ia32.cc</td>
<td>76</td>
</tr>
<tr class="row-odd"><td>assembler_macros_ia32.h</td>
<td>82</td>
</tr>
<tr class="row-even"><td>code_patcher_ia32.cc</td>
<td>297</td>
</tr>
<tr class="row-odd"><td>constants_ia32.h</td>
<td>135</td>
</tr>
<tr class="row-even"><td>cpu_ia32.cc</td>
<td>29</td>
</tr>
<tr class="row-odd"><td>debugger_ia32.cc</td>
<td>68</td>
</tr>
<tr class="row-even"><td>disassembler_ia32.cc</td>
<td>1711</td>
</tr>
<tr class="row-odd"><td>flow_graph_compiler_ia32.cc</td>
<td>1435</td>
</tr>
<tr class="row-even"><td>flow_graph_compiler_ia32.h</td>
<td>357</td>
</tr>
<tr class="row-odd"><td>instructions_ia32.cc</td>
<td>52</td>
</tr>
<tr class="row-even"><td>instructions_ia32.h</td>
<td>99</td>
</tr>
<tr class="row-odd"><td>intermediate_language_ia32.cc</td>
<td>2799</td>
</tr>
<tr class="row-even"><td>intrinsifier_ia32.cc</td>
<td>1742</td>
</tr>
<tr class="row-odd"><td>runtime_entry_ia32.cc</td>
<td>39</td>
</tr>
<tr class="row-even"><td>stack_frame_ia32.cc</td>
<td>57</td>
</tr>
<tr class="row-odd"><td>stub_code_ia32.cc</td>
<td>2221</td>
</tr>
</tbody>
</table>
<p>V8の場合、arch依存のコードは、40k lineくらいの規模になります。</p>
<p>コード規模が大きく異なる理由は、</p>
<ol class="arabic simple">
<li>V8はlithiumという低レベル中間表現が存在し、archごとに定義。 10k?</li>
<li>V8はfull-codegenがarchごとに定義。 5k?</li>
<li>V8はregexpがarchごとに定義。2k?</li>
<li>V8はmacro-assemblerを定義。4k?   &lt;&#8211; これは高速化の過程で追加されるかも</li>
</ol>
<p>まだまだ高速化の途中なので、これから増えてくるかもしれません。</p>
</div>
<div class="section" id="id1">
<h2>実行の大まかな流れ<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Dart VMの起動</li>
<li>isolateの生成と初期化(bootstrap含む 詳細は後日)</li>
<li>入力ソースコードを解析する。</li>
<li>ソースコードからASTに変換。</li>
<li>ASTからIRに変換。</li>
<li>IRのJITコンパイル(非最適化)</li>
<li>生成したコードを実行する。</li>
</ol>
</div>
<div class="section" id="fibo">
<h2>サンプルfibo()<a class="headerlink" href="#fibo" title="Permalink to this headline">¶</a></h2>
<p>お馴染みのFibonacciを例に説明します。</p>
<div class="highlight-python"><pre>int fibo(int n) {
  if (n &lt; 2) {
    return n;
  } else {
    return fibo(n - 1) + fibo(n - 2);
  }
}

main() {
  fibo(40);
}
</pre>
</div>
</div>
<div class="section" id="main">
<h2>mainの中間表現<a class="headerlink" href="#main" title="Permalink to this headline">¶</a></h2>
<p>main関数の中間表現です。オプション &#8211;print-flow-graphを指定すると出力できます。</p>
<div class="highlight-python"><pre>==== file:///home/elise/language/dart/work/adven/fibo.dart_::_main
B0[graph]
B1[target]

//prolog
    CheckStackOverflow:2()
//body
    t0 &lt;- Constant:3(#40)
    PushArgument:4(t0)
    StaticCall:5(fibo t0)
//epilog
    t0 &lt;- Constant:6(#null)
    Return:7(t0)

</pre>
</div>
<p>自動的に、CheckStackOverflowとReturnが追加されています。</p>
<p>コードの対応がとりやすいように、prolog body epilogというコメントを入れています。</p>
</div>
<div class="section" id="id2">
<h2>mainのアセンブラ<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>main関数のアセンブラ(非最適化のコンパイル結果)です。オプション &#8211;disassembleを指定すると出力できます。</p>
<p>コメントをいれた、prolog, epilog, runtimeは、自動で挿入された処理だと思ってもらってOkです。</p>
<div class="highlight-python"><pre>code for function 'file:///home/elise/language/dart/work/adven/fibo.dart_::_main' {
//prolog
  CheckStackOverflow:2()
0xb2f88168    55                     push ebp
0xb2f88169    89e5                   mov ebp,esp
0xb2f8816b    e800000000             call 0xb2f88170
0xb2f88170    3b256cfa7f08           cmp esp,[0x87ffa6c]
0xb2f88176    0f8636000000           jna 0xb2f881b2

//main body
  t0 &lt;- Constant:3(#40)
  PushArgument:4(t0)
  StaticCall:5(fibo t0)
0xb2f8817c    b850000000             mov eax,0x50                   &lt;-- fiboの引数40
0xb2f88181    50                     push eax
0xb2f88182    bab16b03b3             mov edx,0xb3036bb1  Array[1, 1, null]
0xb2f88187    e87c823702             call 0xb5300408  [stub: CallStaticFunction] &lt;-- Stub越しにfibo呼び出し
0xb2f8818c    83c404                 add esp,0x4

//epilog
  t0 &lt;- Constant:6(#null)
0xb2f8818f    b8190038b5             mov eax,0xb5380019             &lt;-- 'null'
0xb2f88194    50                     push eax
  Return:7(t0)
0xb2f88195    58                     pop eax
0xb2f88196    ba690421b3             mov edx,0xb3210469  'Function 'main': static.' のテーブル取得。
0xb2f8819b    ff422b                 inc [edx+0x2b]                 &lt;-- 'inc usage_counter'
0xb2f8819e    817a2bd0070000         cmp [edx+0x2b],0x7d0           &lt;-- check hotcode 0x7d0==2000
0xb2f881a5    7c05                   jl 0xb2f881ac
0xb2f881a7    e8fc86ffff             call 0xb2f808a8  [stub: OptimizeFunction] &lt;-- call JITCompiler!!!
0xb2f881ac    89ec                   mov esp,ebp
0xb2f881ae    5d                     pop ebp
0xb2f881af    c3                     ret
0xb2f881b0    90                     nop
0xb2f881b1    cc                     int3

//runtime
0xb2f881b2    b9f0c20a08             mov ecx,0x80ac2f0
0xb2f881b7    ba00000000             mov edx,0
0xb2f881bc    e8677e3702             call 0xb5300028  [stub: CallToRuntime]
0xb2f881c1    ebb9                   jmp 0xb2f8817c
0xb2f881c3    e960833702             jmp 0xb5300528  [stub: FixCallersTarget]
0xb2f881c8    e93b843702             jmp 0xb5300608  [stub: DeoptimizeLazy]
}

</pre>
</div>
<p>1点注意すると、 0x50をfiboの引数40だと説明していますが、 0x50は、十進数で80だと思います。</p>
<p>Dart VMは、V8と同様、最下位ビットがtagged pointerになっています。</p>
<p>tagged pointerに関しては、以下のURLの、実行時のデータ型の表現方法が詳しいです。</p>
<p><a class="reference external" href="http://www.slideshare.net/maedaa/ss-15310134">http://www.slideshare.net/maedaa/ss-15310134</a></p>
<p>ざっくりいうと、最下位bitが0だとSmallInteger(smi)であると判定し、0x50はsmi型の40です。</p>
<p>最下位bitが1だと、HeapObjectとみなします。</p>
</div>
<div class="section" id="id3">
<h2>main関数の実行<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>コンパイルされたコードがどのように実行されるのかざっくり説明します。</p>
<p>中間表現をベースに説明するので、実コードと比較しながら追ってみるとよいかもしれません。</p>
<p>実行:</p>
<div class="highlight-python"><pre>//prolog
CheckStackOverflow:2()    &lt;-- スタックオーバーフローのチェックをします。
//body
t0 &lt;- Constant:3(#40)     &lt;-- 定数40を作成します。
PushArgument:4(t0)        &lt;-- fiboの引数40をスタックにpushします。
StaticCall:5(fibo t0)     &lt;-- fibo関数を呼び出します。もしコンパイルしていない場合、
                              呼び出し先のfibo関数のコンパイルを指示します。
//epilog
t0 &lt;- Constant:6(#null)   &lt;-- nullを生成します。
Return:7(t0)              &lt;-- 後述</pre>
</div>
</div>
<div class="section" id="stub">
<h2>Stub呼び出し<a class="headerlink" href="#stub" title="Permalink to this headline">¶</a></h2>
<p>StaticCallでは、stub越しにfibo関数を呼び出そうとします。</p>
<p>しかしmain開始直後、fibo関数をコンパイルしていません。</p>
<p>StaticCallでは、未コンパイルのソースコードがあればコンパイル(非最適化)を行い、コードを生成します。</p>
<p>その後、StaticCallで呼び出す先のアドレスをpatchingで書き換え、
コンパイル(非最適化)したコードをcallできるようにします。</p>
<p>イメージ図だとこんな感じで、StaticCallが参照するmain関数の呼び出し先テーブルを書き換えます。</p>
<ul class="simple">
<li>書き換え前 : main.StaticCall[fibo]();  // {&#8220;fibo&#8221;:&#8221;fiboのコンパイル指示&#8221;}</li>
<li>書き換え後 : main.StaticCall[fibo]();  // {&#8220;fobo&#8221;:&#8221;fiboのcode&#8221;}</li>
</ul>
</div>
<div class="section" id="return">
<h2>Return処理<a class="headerlink" href="#return" title="Permalink to this headline">¶</a></h2>
<p>Returnをコンパイル(非最適化)したコードでは、結構特殊なことをしています。</p>
<p>Return命令に該当するasm</p>
<div class="highlight-python"><pre>0xb2f88196    ba690421b3             mov edx,0xb3210469  'Function 'main': static.' のテーブル取得。
0xb2f8819b    ff422b                 inc [edx+0x2b]                 &lt;-- 'inc usage_counter'
0xb2f8819e    817a2bd0070000         cmp [edx+0x2b],0x7d0           &lt;-- check hotcode 0x7d0==2000
0xb2f881a5    7c05                   jl 0xb2f881ac
0xb2f881a7    e8fc86ffff             call 0xb2f808a8  [stub: OptimizeFunction] &lt;-- call JITCompiler!!!
0xb2f881ac    89ec                   mov esp,ebp</pre>
</div>
<p>Return処理では、&#8217;main&#8217;関数のテーブルを取得し、
何回実行されたかカウントするusage_counterをインクリメントします。</p>
<p>このテーブルは、関数ごとに用意されています。</p>
<p>その後、そのusage_counterが2000以上か比較し、もし2000以上だった場合stubのOptimizeFunctionを呼び出します。</p>
<p>2000より小さい場合、何もせずretします。</p>
<p>OptimizeFunctionは、再コンパイル(最適化)するためのstubです。</p>
<p>続きは次回で。。</p>
</div>
<div class="section" id="id4">
<h2>まとめ<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Dart VMはインタプリタ実行しない。全部JITコンパイル。</li>
<li>対応OSはLinux Windows MacOS Android</li>
<li>ターゲットアーキテクチャはia32/x64 将来はARMをサポート</li>
<li>サンプルはFibonacci関数。Pointクラスではない。</li>
</ol>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="advent20121203.html">Dart VM Advent Calendar 2012 12/03</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>


    <div class="footer">
        &copy; Copyright 2012, nothingcosmos.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15223787-5']);
  _gaq.push(['_trackPageview']);

  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
   })();

</script>


  </body>
</html>