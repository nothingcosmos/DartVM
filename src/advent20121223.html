

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dart VM Advent Calendar 2012 12/23 &mdash; Dart VM Overview 1.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="Dart VM Overview 1.0 documentation" href="../index.html" />
    <link rel="up" title="Dart VM index" href="advent201212index.html" />
    <link rel="next" title="Dart VM Advent Calendar 2012 12/24" href="advent20121224.html" />
    <link rel="prev" title="Dart VM Advent Calendar 2012 12/21" href="advent20121221.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Dart VM Overview 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Dart VM Advent Calendar 2012 12/23</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="advent20121221.html">Dart VM Advent Calendar 2012 12/21</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advent20121224.html">Dart VM Advent Calendar 2012 12/24</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="dart-vm-advent-calendar-2012-12-23">
<h1>Dart VM Advent Calendar 2012 12/23<a class="headerlink" href="#dart-vm-advent-calendar-2012-12-23" title="Permalink to this headline">¶</a></h1>
<div class="section" id="dart">
<h2>Dartのアーキテクチャ<a class="headerlink" href="#dart" title="Permalink to this headline">¶</a></h2>
<p>advent calendar drivenに色々調べてきた結果、全体アーキテクチャがなんとなく見えてきたので、その概要を紹介します。</p>
<p class="blockdiag">
<img src="../images/blockdiag-88ea67f4b6dde104e06e405be259581b7d79a3b4.png" alt="None" width="832" height="520" />
</p>
<p>pinkがDartのソースコードで、blueがC++のソースコードになります。</p>
<p>greenのnative extensionが仲介して、DartからC++のオブジェクトやメソッドをbindingします。</p>
<p>多くの場合、dart/sdkの下は、APIのインタフェースや抽象クラスのみ提供し、
実装はruntimeの下で定義されていることが多いです。</p>
<p>また、Coreに対応するC++のオブジェクトが定義されており、
必要最低限定義されたC++のオブジェクトをbindするのは、BootstrapNativesです。</p>
<p>必要最低限といいながら、高速化にために定義しているものも多いです。</p>
</div>
<div class="section" id="dart-vm">
<h2>Dart VMのビルド<a class="headerlink" href="#dart-vm" title="Permalink to this headline">¶</a></h2>
<p>Dart VMのビルドは複数のフェーズから構成されています。</p>
<ol class="arabic simple">
<li>必須のC++ソースコードのコンパイル。
runtime/libやruntime/platform下をコンパイルします。</li>
<li>VM本体のコンパイル。
runtime/vmの下をコンパイルします。</li>
<li>builtin系C++ソースコードのコンパイル。
runtime/libおよびruntime/binのbuiltin系をコンパイルします。</li>
<li>VM本体のビルドとtest。
上記のC++のオブジェクトを組み合わせてVM本体をビルドし、テストを走らせます。</li>
<li>SDKやCoreのソースコードのsnapshot。
SDKとCoreのソースコードを、VM本体のgen_snapshotを使って、parseしてASTに変換したのちserializeします。</li>
<li>Dart VM本体と、main.ccと、serializeしたバイナリを組み合わせて、dart を作成する。</li>
</ol>
<p>上記アーキテクチャの下の方から順にコンパイルしていきます。</p>
<p>VM本体を生成してからSDKとinternalのdart ソースコードをsnapshotし、すべてを内包したdartコマンドを生成します。</p>
<p>そのため、dart本体は起動時にASTをdeserializeするだけであり、起動時のfile ioとparse処理が不要になり高速に起動できます。</p>
<p>またgen_snapshotコマンドにより、ユーザプログラムもシリアライズして組み込んでおき、ユーザプログラムの高速な起動も可能なはずですが、試せていないです。</p>
</div>
<div class="section" id="bootstrapnatives">
<h2>BootstrapNatives<a class="headerlink" href="#bootstrapnatives" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>// Copyright (c) 2012, the Dart project authors.  Please see the AUTHORS file
// for details. All rights reserved. Use of this source code is governed by a
// BSD-style license that can be found in the LICENSE file.

#ifndef VM_BOOTSTRAP_NATIVES_H_
#define VM_BOOTSTRAP_NATIVES_H_

#include "vm/native_entry.h"

// bootstrap dart natives used in the core dart library.

namespace dart {

// List of bootstrap native entry points used in the core dart library.
#define BOOTSTRAP_NATIVE_LIST(V)                                               \
  V(Object_toString, 1)                                                        \
  V(Object_noSuchMethod, 5)                                                    \
  V(Object_runtimeType, 1)                                                     \
  V(Function_apply, 2)                                                         \
  V(InvocationMirror_invoke, 4)                                                \
  V(AbstractType_toString, 1)                                                  \
  V(Identical_comparison, 2)                                                   \
  V(Integer_bitAndFromInteger, 2)                                              \
  V(Integer_bitOrFromInteger, 2)                                               \
  V(Integer_bitXorFromInteger, 2)                                              \
  V(Integer_addFromInteger, 2)                                                 \
  V(Integer_subFromInteger, 2)                                                 \
  V(Integer_mulFromInteger, 2)                                                 \
  V(Integer_truncDivFromInteger, 2)                                            \
  V(Integer_moduloFromInteger, 2)                                              \
  V(Integer_greaterThanFromInteger, 2)                                         \
  V(Integer_equalToInteger, 2)                                                 \
  V(Integer_parse, 1)                                                          \
  V(ReceivePortImpl_factory, 1)                                                \
  V(ReceivePortImpl_closeInternal, 1)                                          \
  V(SendPortImpl_sendInternal_, 3)                                             \
  V(Smi_shlFromInt, 2)                                                         \
  V(Smi_shrFromInt, 2)                                                         \
  V(Smi_bitNegate, 1)                                                          \
  V(Mint_bitNegate, 1)                                                         \
  V(Bigint_bitNegate, 1)                                                       \
  V(Double_getIsNegative, 1)                                                   \
  V(Double_getIsInfinite, 1)                                                   \
  V(Double_getIsNaN, 1)                                                        \
  V(Double_add, 2)                                                             \
  V(Double_sub, 2)                                                             \
  V(Double_mul, 2)                                                             \
  V(Double_div, 2)                                                             \
  V(Double_trunc_div, 2)                                                       \
  V(Double_remainder, 2)                                                       \
  V(Double_modulo, 2)                                                          \
  V(Double_greaterThanFromInteger, 2)                                          \
  V(Double_equalToInteger, 2)                                                  \
  V(Double_greaterThan, 2)                                                     \
  V(Double_equal, 2)                                                           \
  V(Double_doubleFromInteger, 2)                                               \
  V(Double_round, 1)                                                           \
  V(Double_floor, 1)                                                           \
  V(Double_ceil, 1)                                                            \
  V(Double_truncate, 1)                                                        \
  V(Double_toInt, 1)                                                           \
  V(Double_parse, 1)                                                           \
  V(Double_toStringAsFixed, 2)                                                 \
  V(Double_toStringAsExponential, 2)                                           \
  V(Double_toStringAsPrecision, 2)                                             \
  V(Double_pow, 2)                                                             \
  V(JSSyntaxRegExp_factory, 4)                                                 \
  V(JSSyntaxRegExp_getPattern, 1)                                              \
  V(JSSyntaxRegExp_multiLine, 1)                                               \
  V(JSSyntaxRegExp_ignoreCase, 1)                                              \
  V(JSSyntaxRegExp_getGroupCount, 1)                                           \
  V(JSSyntaxRegExp_ExecuteMatch, 3)                                            \
  V(ObjectArray_allocate, 2)                                                   \
  V(ObjectArray_getIndexed, 2)                                                 \
  V(ObjectArray_setIndexed, 3)                                                 \
  V(ObjectArray_getLength, 1)                                                  \
  V(ObjectArray_copyFromObjectArray, 5)                                        \
  V(StringBase_createFromCodePoints, 1)                                        \
  V(StringBase_substringUnchecked, 3)                                          \
  V(OneByteString_substringUnchecked, 3)                                       \
  V(OneByteString_splitWithCharCode, 2)                                        \
  V(String_getHashCode, 1)                                                     \
  V(String_getLength, 1)                                                       \
  V(String_charAt, 2)                                                          \
  V(String_charCodeAt, 2)                                                      \
  V(String_concat, 2)                                                          \
  V(String_toLowerCase, 1)                                                     \
  V(String_toUpperCase, 1)                                                     \
  V(Strings_concatAll, 1)                                                      \
  V(Math_sqrt, 1)                                                              \
  V(Math_sin, 1)                                                               \
  V(Math_cos, 1)                                                               \
  V(Math_tan, 1)                                                               \
  V(Math_asin, 1)                                                              \
  V(Math_acos, 1)                                                              \
  V(Math_atan, 1)                                                              \
  V(Math_atan2, 2)                                                             \
  V(Math_exp, 1)                                                               \
  V(Math_log, 1)                                                               \
  V(DateNatives_currentTimeMillis, 0)                                          \
  V(DateNatives_timeZoneName, 1)                                               \
  V(DateNatives_timeZoneOffsetInSeconds, 1)                                    \
  V(DateNatives_localTimeZoneAdjustmentInSeconds, 0)                           \
  V(AssertionError_throwNew, 2)                                                \
  V(TypeError_throwNew, 5)                                                     \
  V(FallThroughError_throwNew, 1)                                              \
  V(AbstractClassInstantiationError_throwNew, 2)                               \
  V(NoSuchMethodError_throwNew, 2)                                             \
  V(Stopwatch_now, 0)                                                          \
  V(Stopwatch_frequency, 0)                                                    \
  V(ByteArray_getLength, 1)                                                    \
  V(ByteArray_getInt8, 2)                                                      \
  V(ByteArray_setInt8, 3)                                                      \
  V(ByteArray_getUint8, 2)                                                     \
  V(ByteArray_setUint8, 3)                                                     \
  V(ByteArray_getInt16, 2)                                                     \
  V(ByteArray_setInt16, 3)                                                     \
  V(ByteArray_getUint16, 2)                                                    \
  V(ByteArray_setUint16, 3)                                                    \
  V(ByteArray_getInt32, 2)                                                     \
  V(ByteArray_setInt32, 3)                                                     \
  V(ByteArray_getUint32, 2)                                                    \
  V(ByteArray_setUint32, 3)                                                    \
  V(ByteArray_getInt64, 2)                                                     \
  V(ByteArray_setInt64, 3)                                                     \
  V(ByteArray_getUint64, 2)                                                    \
  V(ByteArray_setUint64, 3)                                                    \
  V(ByteArray_getFloat32, 2)                                                   \
  V(ByteArray_setFloat32, 3)                                                   \
  V(ByteArray_getFloat64, 2)                                                   \
  V(ByteArray_setFloat64, 3)                                                   \
  V(ByteArray_setRange, 5)                                                     \
  V(Int8Array_new, 1)                                                          \
  V(Int8Array_newTransferable, 1)                                              \
  V(Int8Array_getIndexed, 2)                                                   \
  V(Int8Array_setIndexed, 3)                                                   \
  V(Uint8Array_new, 1)                                                         \
  V(Uint8Array_newTransferable, 1)                                             \
  V(Uint8Array_getIndexed, 2)                                                  \
  V(Uint8Array_setIndexed, 3)                                                  \
  V(Uint8ClampedArray_new, 1)                                                  \
  V(Uint8ClampedArray_newTransferable, 1)                                      \
  V(Uint8ClampedArray_getIndexed, 2)                                           \
  V(Uint8ClampedArray_setIndexed, 3)                                           \
  V(Int16Array_new, 1)                                                         \
  V(Int16Array_newTransferable, 1)                                             \
  V(Int16Array_getIndexed, 2)                                                  \
  V(Int16Array_setIndexed, 3)                                                  \
  V(Uint16Array_new, 1)                                                        \
  V(Uint16Array_newTransferable, 1)                                            \
  V(Uint16Array_getIndexed, 2)                                                 \
  V(Uint16Array_setIndexed, 3)                                                 \
  V(Int32Array_new, 1)                                                         \
  V(Int32Array_newTransferable, 1)                                             \
  V(Int32Array_getIndexed, 2)                                                  \
  V(Int32Array_setIndexed, 3)                                                  \
  V(Uint32Array_new, 1)                                                        \
  V(Uint32Array_newTransferable, 1)                                            \
  V(Uint32Array_getIndexed, 2)                                                 \
  V(Uint32Array_setIndexed, 3)                                                 \
  V(Int64Array_new, 1)                                                         \
  V(Int64Array_newTransferable, 1)                                             \
  V(Int64Array_getIndexed, 2)                                                  \
  V(Int64Array_setIndexed, 3)                                                  \
  V(Uint64Array_new, 1)                                                        \
  V(Uint64Array_newTransferable, 1)                                            \
  V(Uint64Array_getIndexed, 2)                                                 \
  V(Uint64Array_setIndexed, 3)                                                 \
  V(Float32Array_new, 1)                                                       \
  V(Float32Array_newTransferable, 1)                                           \
  V(Float32Array_getIndexed, 2)                                                \
  V(Float32Array_setIndexed, 3)                                                \
  V(Float64Array_new, 1)                                                       \
  V(Float64Array_newTransferable, 1)                                           \
  V(Float64Array_getIndexed, 2)                                                \
  V(Float64Array_setIndexed, 3)                                                \
  V(ExternalInt8Array_getIndexed, 2)                                           \
  V(ExternalInt8Array_setIndexed, 3)                                           \
  V(ExternalUint8Array_getIndexed, 2)                                          \
  V(ExternalUint8Array_setIndexed, 3)                                          \
  V(ExternalInt16Array_getIndexed, 2)                                          \
  V(ExternalInt16Array_setIndexed, 3)                                          \
  V(ExternalUint16Array_getIndexed, 2)                                         \
  V(ExternalUint16Array_setIndexed, 3)                                         \
  V(ExternalInt32Array_getIndexed, 2)                                          \
  V(ExternalInt32Array_setIndexed, 3)                                          \
  V(ExternalUint32Array_getIndexed, 2)                                         \
  V(ExternalUint32Array_setIndexed, 3)                                         \
  V(ExternalInt64Array_getIndexed, 2)                                          \
  V(ExternalInt64Array_setIndexed, 3)                                          \
  V(ExternalUint64Array_getIndexed, 2)                                         \
  V(ExternalUint64Array_setIndexed, 3)                                         \
  V(ExternalFloat32Array_getIndexed, 2)                                        \
  V(ExternalFloat32Array_setIndexed, 3)                                        \
  V(ExternalFloat64Array_getIndexed, 2)                                        \
  V(ExternalFloat64Array_setIndexed, 3)                                        \
  V(isolate_getPortInternal, 0)                                                \
  V(isolate_spawnFunction, 2)                                                  \
  V(isolate_spawnUri, 1)                                                       \
  V(Mirrors_isLocalPort, 1)                                                    \
  V(Mirrors_makeLocalInstanceMirror, 1)                                        \
  V(Mirrors_makeLocalMirrorSystem, 0)                                          \
  V(LocalObjectMirrorImpl_invoke, 3)                                           \
  V(LocalObjectMirrorImpl_getField, 2)                                         \
  V(LocalObjectMirrorImpl_setField, 3)                                         \
  V(LocalClosureMirrorImpl_apply, 2)                                           \
  V(LocalClassMirrorImpl_invokeConstructor, 3)                                 \
  V(GrowableObjectArray_allocate, 2)                                           \
  V(GrowableObjectArray_getIndexed, 2)                                         \
  V(GrowableObjectArray_setIndexed, 3)                                         \
  V(GrowableObjectArray_getLength, 1)                                          \
  V(GrowableObjectArray_getCapacity, 1)                                        \
  V(GrowableObjectArray_setLength, 2)                                          \
  V(GrowableObjectArray_setData, 2)                                            \
  V(WeakProperty_new, 2)                                                       \
  V(WeakProperty_getKey, 1)                                                    \
  V(WeakProperty_getValue, 1)                                                  \
  V(WeakProperty_setValue, 2)                                                  \

class BootstrapNatives : public AllStatic {
 public:
  static Dart_NativeFunction Lookup(Dart_Handle name, int argument_count);

#define DECLARE_BOOTSTRAP_NATIVE(name, ignored)                                \
  static void DN_##name(Dart_NativeArguments args);

  BOOTSTRAP_NATIVE_LIST(DECLARE_BOOTSTRAP_NATIVE)

#undef DECLARE_BOOTSTRAP_NATIVE
};

}  // namespace dart

#endif  // VM_BOOTSTRAP_NATIVES_H_
</pre>
</div>
<p>Dartの基本的なデータは構造は、すべてDart VMで定義されており、
すべてbootstrap_nativesを介してbindingされます。</p>
<p>上記にないものは、bootstrap_nativesを組み合わせて作成するオブジェクトのはずです。</p>
<p>bootstrap_natives以外にも、builtin_nativesやio_nativesがruntme/binに定義されており、
それらはOSの基本機能(IO File Socket Thread Crypt Processなど)を操作するC++オブジェクトにbindingします。</p>
</div>
<div class="section" id="string">
<h2>Stringの階層構造<a class="headerlink" href="#string" title="Permalink to this headline">¶</a></h2>
<p>Stringをサンプルに階層構造をみると、以下のようになります。</p>
<p class="blockdiag">
<img src="../images/blockdiag-45819748fa3e6198bef2720758f8242368ff75bb.png" alt="None" width="640" height="520" />
</p>
<p>基本的なCore APIは、すべて上記のように綺麗な階層に分かれるはずです。</p>
</div>
<div class="section" id="jit">
<h2>JITコンパイルされたコードとの連携<a class="headerlink" href="#jit" title="Permalink to this headline">¶</a></h2>
<p>JITコンパイルされたコードは、どのような階層になるのでしょうか。</p>
<p class="blockdiag">
<img src="../images/blockdiag-29240d35470d4560d598860ceba24ddbd5a2011a.png" alt="None" width="832" height="520" />
</p>
<p>Dartのソースコードは、Dart VMを操作するDart APIを使用し、ソースコードをloadscriptしてJITコンパイルします。</p>
<p>JITコンパイルされたコードには、StubsやBootstrapへの呼び出しを埋め込んコードを生成します。</p>
<p>JITコンパイルされたコードは、Stubs経由でVM連携用の処理を呼び出したり、Nativeに用意されたメソッドを呼び出します。</p>
</div>
<div class="section" id="id1">
<h2>まとめ<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Dart Binding C++の3階層に分かれる。</li>
<li>Coreのオブジェクトは、Dart VM内のC++オブジェクトとbindingする。</li>
<li>JITコンパイルされたコードは、BootstrapされたNativeシンボルおよびStubsを経由してVMと連携する。</li>
<li>次はDart VMのアーキテクチャを、、</li>
</ol>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="advent20121221.html">Dart VM Advent Calendar 2012 12/21</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advent20121224.html">Dart VM Advent Calendar 2012 12/24</a>&#160;&#160;»
        </p>

      </div>


    <div class="footer">
        &copy; Copyright 2012, nothingcosmos.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15223787-5']);
  _gaq.push(['_trackPageview']);

  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
   })();

</script>


  </body>
</html>