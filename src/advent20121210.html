

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Garbage Collection Advent Calendar 2012 12/10 &mdash; Dart VM Overview 1.0 documentation</title>
    
    <link rel="stylesheet" href="../static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="Dart VM Overview 1.0 documentation" href="../index.html" />
    <link rel="up" title="Dart VM index" href="advent201212index.html" />
    <link rel="next" title="Dart VM Advent Calendar 2012 12/11" href="advent20121211.html" />
    <link rel="prev" title="Dart VM Advent Calendar 2012 12/09" href="advent20121209.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>Dart VM Overview 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Garbage Collection Advent Calendar 2012 12/10</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="advent20121209.html">Dart VM Advent Calendar 2012 12/09</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advent20121211.html">Dart VM Advent Calendar 2012 12/11</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="garbage-collection-advent-calendar-2012-12-10">
<h1>Garbage Collection Advent Calendar 2012 12/10<a class="headerlink" href="#garbage-collection-advent-calendar-2012-12-10" title="Permalink to this headline">¶</a></h1>
<p>Dart VMのGarbage Collectionの紹介、その概要編です。</p>
<p>Dart VMは、googleが開発中のプログラミング言語Dart用のVMで、
JavaScriptとV8みたいな関係です。</p>
<p>Dart VMもV8と同様、C++で開発されています。</p>
<div class="section" id="gc">
<h2>GCの概要<a class="headerlink" href="#gc" title="Permalink to this headline">¶</a></h2>
<p>GCは、世代別GCを採用しています。</p>
<p>世代別GCの概要はGC本を参照しましょう。</p>
<p><a class="reference external" href="http://www.amazon.co.jp/exec/obidos/ASIN/4798025623/nothingcosm05-22/ref=nosim">http://www.amazon.co.jp/exec/obidos/ASIN/4798025623/nothingcosm05-22/ref=nosim</a></p>
<p>世代別GCなので、ヒープ領域をNew領域とOld領域に分けます。</p>
<ul class="simple">
<li>New領域は、CopyGC</li>
<li>Old領域は、Mark&amp;SweepGC</li>
</ul>
<p>New領域(デフォルト32M)とOld領域のサイズ(デフォルト512M)は、VMの起動時のオプションで指定できます。</p>
<p>Heapサイズを指定するオプション</p>
<div class="highlight-python"><pre>$ dart --verbose | grep heap
new_gen_heap_size: 32 (new gen heap size in MB,e.g: --new_gen_heap_size=64 allocates a 64MB new gen heap)
old_gen_heap_size: 512 (old gen heap size in MB,e.g: --old_gen_heap_size=1024 allocates a 1024MB old gen heap)</pre>
</div>
</div>
<div class="section" id="copygc">
<h2>CopyGC<a class="headerlink" href="#copygc" title="Permalink to this headline">¶</a></h2>
<p>CopyGCの概要は、GC本を参照しましょう。</p>
<p><a class="reference external" href="http://www.amazon.co.jp/exec/obidos/ASIN/4798025623/nothingcosm05-22/ref=nosim">http://www.amazon.co.jp/exec/obidos/ASIN/4798025623/nothingcosm05-22/ref=nosim</a></p>
<p>New領域はCopyGCなので、複数に分割された領域が必要になります。</p>
<p>Dart VMの場合、2分割して16M、2分割した領域を相互に移動して、CopyGCを実現します。</p>
<p>世代別GCですので、ある条件を満たすと、New領域からOld領域にPromotionします。</p>
<p>Promotionの条件に、Age(年齢)は存在しません。
JVM(HotSpot)の場合、CopyGCを20回生き延びたらOld領域に移動するんだったかな？</p>
</div>
<div class="section" id="mark-sweepgc">
<h2>Mark&amp;SweepGC<a class="headerlink" href="#mark-sweepgc" title="Permalink to this headline">¶</a></h2>
<p>Mark&amp;SweepGCの概要はGC本を参照しましょう。</p>
<p><a class="reference external" href="http://www.amazon.co.jp/exec/obidos/ASIN/4798025623/nothingcosm05-22/ref=nosim">http://www.amazon.co.jp/exec/obidos/ASIN/4798025623/nothingcosm05-22/ref=nosim</a></p>
<p>Old領域は、PageとLargePageに分けて管理します。</p>
<p>Pageは、PageSize単位でAllocation(mmap)した領域で、
小さなオブジェクトはすべてPageにAllocationされます。</p>
<p>Sweep対象のオブジェクトがPageに配置されていた場合、
フリーな領域とした後、freelistで管理し再利用します。</p>
<p>LargePageは、PageSizeに収まらないような大きなオブジェクトが該当し、
適時Allocation(mmap)とSweep(munmap)を行います。</p>
</div>
<div class="section" id="id1">
<h2>GCの構成<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>非常にシンプルですね。そうか、Mark&amp;Sweep GCなんだねー。</p>
<table border="1" class="docutils">
<caption>GCのソースコード(1)</caption>
<colgroup>
<col width="25%" />
<col width="13%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">filename</th>
<th class="head">line</th>
<th class="head">overview</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>gc_callbacks.h</td>
<td>100</td>
<td>gcのprolog epilog用callback定義</td>
</tr>
<tr class="row-odd"><td>gc_marker.h</td>
<td>50</td>
<td>GCMarkerの定義</td>
</tr>
<tr class="row-even"><td>gc_marker.cc</td>
<td>400</td>
<td>markの処理、PointerVisitor</td>
</tr>
<tr class="row-odd"><td>gc_sweeper.h</td>
<td>40</td>
<td>GCSweeperの定義</td>
</tr>
<tr class="row-even"><td>gc_sweeper.cc</td>
<td>80</td>
<td>sweepの処理</td>
</tr>
</tbody>
</table>
<p>そう思っていた時期が。。</p>
<table border="1" class="docutils">
<caption>GCのソースコード(2)</caption>
<colgroup>
<col width="25%" />
<col width="13%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">filename</th>
<th class="head">line</th>
<th class="head">overview</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>heap.h</td>
<td>200</td>
<td>Heapの定義</td>
</tr>
<tr class="row-odd"><td>heap.cc</td>
<td>350</td>
<td>GCの管理とAllocation用I/Fの提供</td>
</tr>
<tr class="row-even"><td>scavenger.h</td>
<td>200</td>
<td>Scavengerの定義</td>
</tr>
<tr class="row-odd"><td>scavenger.cc</td>
<td>700</td>
<td>CopyGCの処理と、Promotion、Allocation、PointerVisitor</td>
</tr>
<tr class="row-even"><td>memory_region.h</td>
<td>80</td>
<td>MemoryRegionの定義</td>
</tr>
<tr class="row-odd"><td>memory_region.cc</td>
<td>20</td>
<td>toとfromを2分割する</td>
</tr>
<tr class="row-even"><td>pages.h</td>
<td>100</td>
<td>PageSpaceとHeapPageの定義</td>
</tr>
<tr class="row-odd"><td>pages.cc</td>
<td>600</td>
<td>Allocation、領域確保、再利用</td>
</tr>
<tr class="row-even"><td>freelist.h</td>
<td>100</td>
<td>FreeListとFreeListElementの定義</td>
</tr>
<tr class="row-odd"><td>freelist.cc</td>
<td>200</td>
<td>Elementの分割結合、リスト管理と解放</td>
</tr>
</tbody>
</table>
<p>他にもGCに関連するファイルやクラスはありますが、おいおい。。</p>
</div>
<div class="section" id="id2">
<h2>依存関係<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>イメージ図です。</p>
<p class="blockdiag">
<img src="../images/blockdiag-f9d6fd46c7812886665f94258d43fa3a21a86909.png" alt="None" width="640" height="280" />
</p>
<p class="blockdiag">
<img src="../images/blockdiag-e87fe491553d0982253a2e313879feb9aa0a71f7.png" alt="None" width="640" height="280" />
</p>
</div>
<div class="section" id="isolateheap">
<h2>IsolateとHeap<a class="headerlink" href="#isolateheap" title="Permalink to this headline">¶</a></h2>
<p>Dart VMのGCの対象はHeapクラスであり、IsolateごとにHeapとGCを管理します。</p>
<p>そのためIsolateがSpawnされた場合、子Isolateは初期化し、新たなHeapを作成します。</p>
<p>IsolateごとにHeapとGCが分割されているため、GC処理中にLockや同期処理はないです。</p>
<p class="blockdiag">
<img src="../images/blockdiag-a4aded6b549338ffedd049ed9bda57db9888dfb5.png" alt="None" width="640" height="200" />
</p>
<p>HeapクラスがScavengerとPageSpaceを生成し、管理します。</p>
<p>昔はcode_space_がありましたが、old_space_に統合されました。</p>
<p>heapの生成箇所</p>
<div class="highlight-python"><pre>Heap::Heap() {
  ...
  new_space_ = new Scavenger(this, ...)
  old_space_ = new PageSpace(this, ...)
  ...
}

Heap::~Heap() {
  delete new_space_;
  delete old_space_;
}</pre>
</div>
</div>
<div class="section" id="id3">
<h2>GCの起点<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>HeapはAllocate用のインターフェースのみ提供します。</p>
<p>そのため、Allocateに失敗した場合にGCが走ります。</p>
<p>GCの起点</p>
<div class="highlight-python"><pre>Heap::CollectGarbage(Space) {
  switch (space) {
  case kNew:
    new_space_-&gt;Scavenge();
    if (new_space_-&gt;HadPromotionFailure()) { &lt;-- Promotionに失敗した、
      old_space-&gt;MarkSweep();
    }
  case kOld:
  case kCode:
    old_space_-&gt;MarkSweep();
  }
}

Heap::CollectAllGarbage() {
  new_space-&gt;Scavenge();
  old_space-&gt;MarkSweep();
}</pre>
</div>
<p>Allocateの起点</p>
<div class="highlight-python"><pre>// Heap.h
uword Allocate(intptr_t size, Space space) {   //spaceタグで、New、Oldを選べる。
  ASSERT(!read_only_);                         //APIの種類に応じて、最初からOld領域指定もある。
  switch (space) {
    case kNew:
      // Do not attempt to allocate very large objects in new space.
      if (!PageSpace::IsPageAllocatableSize(size)) {   &lt;-- PageSize以上のものは、Old領域へ
        return AllocateOld(size, HeapPage::kData);
      }
      return AllocateNew(size);
    case kOld:
      return AllocateOld(size, HeapPage::kData);
    case kCode:
      return AllocateOld(size, HeapPage::kExecutable); &lt;-- Codeは、Old領域へ確保
    default:
      UNREACHABLE();
  }
  return 0;
}

Heap::AllocateNew(size) {
  uward addr = new_space_-&gt;TryAllocate(size);
  if (addr != 0) {
    return addr;
  }
  CollectGarbage(kNew)                 &lt;-- NewのAllocateに失敗したらGC
  addr = new_space_-&gt;TryAllocate(size);
  if (addr != 0) {
    return addr;
  }
  return AllocateOld(size, HeapPage::kData); &lt;-- 再度失敗したらOld領域に確保
}

Heap::AllocateOld(size, type) {
  uword addr = old_space_-&gt;TryAllocate(size, type);
  if (addr == 0) {
    CollectAllGarbage();                     &lt;-- 失敗したらGC
    addr = old_space_-&gt;TryAllocate(size, type, kForceGrowth);
    if (addr == 0) {
      OS::PrintErr(Exhausted heap space, ...
    }
  }
  return addr;
}</pre>
</div>
</div>
<div class="section" id="id4">
<h2>メンテナ<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>new領域管理のScavengerは、initial checkinからありました。</p>
<p>その後rev2000頃、世代別gcのOld領域管理(gc_marker gc_sweeper)を追加。</p>
<p>主なメンテナは下記の2名です。</p>
<ol class="arabic simple">
<li><a class="reference external" href="mailto:cshapiro&#37;&#52;&#48;google&#46;com">cshapiro<span>&#64;</span>google<span>&#46;</span>com</a></li>
<li><a class="reference external" href="mailto:iposva&#37;&#52;&#48;google&#46;com">iposva<span>&#64;</span>google<span>&#46;</span>com</a> V8の開発もされていた方ですね。</li>
</ol>
</div>
<div class="section" id="id5">
<h2>まとめ<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Dart VMのGCは世代別GC</li>
<li>New領域は、CopyGC(Scavenger)で掃除する。</li>
<li>Old領域は、Mark&amp;SweepGCで掃除する。</li>
<li>GC本は偉大だった。</li>
<li>詳細編があるとよいですね。。</li>
</ol>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="advent20121209.html">Dart VM Advent Calendar 2012 12/09</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="advent20121211.html">Dart VM Advent Calendar 2012 12/11</a>&#160;&#160;»
        </p>

      </div>


    <div class="footer">
        &copy; Copyright 2012, nothingcosmos.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15223787-5']);
  _gaq.push(['_trackPageview']);

  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
   })();

</script>


  </body>
</html>